<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz | SDEL</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #44749D; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    #timer {
      font-size: 1.5rem; font-weight: bold; color: #d32f2f; margin: 30px 0 10px;
      background-color: #fff3f3; padding: 10px 20px; border: 2px solid #d32f2f;
      border-radius: 8px; box-shadow: 0 0 10px rgba(211, 47, 47, 0.2); display: none;
    }
    .app {
      background: #fff; width: 90%; max-width: 600px; padding: 30px;
      border-radius: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.35);
    }
    h1 {
      color: #001e4d; font-weight: 600; border-bottom: 1px solid #333;
      padding-bottom: 30px; text-align: center;
    }
    .quiz { padding: 20px 0; }
    .quiz h2 { font-size: 18px; color: #001e4d; font-weight: 600; }
    .btn {
      background: #fff; color: #222; font-weight: 500; width: 100%;
      border: 1px solid #222; padding: 10px; margin: 10px 0; text-align: left;
      border-radius: 4px; cursor: pointer; transition: all 0.3s;
    }
    .btn:hover:not([disabled]) { background: #222; color: #fff; }
    .btn:disabled { cursor: no-drop; }
    #next-btn {
      background: #001e4d; color: #fff; font-weight: 500; width: 150px;
      border: 0; padding: 10px; margin: 20px auto 0; border-radius: 4px;
      cursor: pointer; display: none;
    }
    .correct { background: #9aeabc; }
    .incorrect { background: #ff9393; }
    .progress-bar-container { width: 100%; margin-bottom: 20px; }
    progress { width: 100%; height: 20px; }
    #filter-section {
      background: #fff; padding: 20px; border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 20px;
      width: 90%; max-width: 600px;
    }
    #filter-section h2 { margin-bottom: 10px; color: #001e4d; }
    #filter-section label { display: block; margin-bottom: 8px; }
    #start-btn {
      background: #001e4d; color: #fff; font-weight: 500; border: none;
      padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="timer">02:30:00</div>

  <!-- Filtro por matérias -->
  <div id="filter-section">
    <h2>Escolha as matérias de Matemática:</h2>
    <label><input type="checkbox" value="álgebra" /> Álgebra</label>
    <label><input type="checkbox" value="geometria" /> Geometria</label>
    <label><input type="checkbox" value="aritmética" /> Aritmética</label>
    <label><input type="checkbox" value="funções" /> Funções</label>
    <label><input type="checkbox" value="probabilidade" /> Probabilidade</label>
    <button id="start-btn">Iniciar Quiz</button>
  </div>

  <!-- Quiz App -->
  <div class="app" style="display: none;">
    <h1>Quiz</h1>
    <div class="progress-bar-container">
      <progress id="progress-bar" value="0" max="100"></progress>
    </div>
    <div class="quiz">
      <h2 id="question">Questão</h2>
      <div id="answer-buttons"></div>
      <button id="next-btn">Próximo</button>
    </div>
  </div>

  <!-- Firebase e lógica do quiz -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCj8i37JYNigvbhXfqP4HVzjAEOzcXf_i0",
      authDomain: "sdel-b3f65.firebaseapp.com",
      projectId: "sdel-b3f65",
      storageBucket: "sdel-b3f65.appspot.com",
      messagingSenderId: "297725999985",
      appId: "1:297725999985:web:d41da68311c190ef8a54d0",
      measurementId: "G-PT92VECJ2H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const allQuestions = [
      { question: "Qual o valor de x na equação 2x + 5 = 11?", subject: "álgebra", answers: [{ id: 1, text: "2", correct: false }, { id: 2, text: "3", correct: true }, { id: 3, text: "4", correct: false }, { id: 4, text: "5", correct: false }, { id: 5, text: "6", correct: false }] },
      { question: "Área de um triângulo com base 8 e altura 5?", subject: "geometria", answers: [{ id: 1, text: "20", correct: true }, { id: 2, text: "30", correct: false }, { id: 3, text: "40", correct: false }, { id: 4, text: "15", correct: false }, { id: 5, text: "25", correct: false }] },
      { question: "Quanto é 15% de 200?", subject: "aritmética", answers: [{ id: 1, text: "20", correct: false }, { id: 2, text: "25", correct: false }, { id: 3, text: "30", correct: true }, { id: 4, text: "35", correct: false }, { id: 5, text: "40", correct: false }] },
      { question: "A função f(x) = x² é:", subject: "funções", answers: [{ id: 1, text: "Linear", correct: false }, { id: 2, text: "Exponencial", correct: false }, { id: 3, text: "Quadrática", correct: true }, { id: 4, text: "Afim", correct: false }, { id: 5, text: "Constante", correct: false }] },
      { question: "A chance de sair cara ao lançar uma moeda é:", subject: "probabilidade", answers: [{ id: 1, text: "1/3", correct: false }, { id: 2, text: "1/4", correct: false }, { id: 3, text: "1/2", correct: true }, { id: 4, text: "2/3", correct: false }, { id: 5, text: "2/5", correct: false }] },
    ];

    const filterSection = document.getElementById("filter-section");
    const startBtn = document.getElementById("start-btn");
    const quizApp = document.querySelector(".app");

    let selectedQuestions = [];
    let currentUser = null;
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval;
    let totalTime = 2 * 60 * 60 + 30 * 60; // 2h30min
    const timerElement = document.getElementById("timer");
    const questionElement = document.getElementById("question");
    const answerButtons = document.getElementById("answer-buttons");
    const nextButton = document.getElementById("next-btn");
    const progressBar = document.getElementById("progress-bar");

    onAuthStateChanged(auth, user => {
      if (user) currentUser = user;
      else {
        alert("Faça login para acessar o quiz.");
        window.location.href = "login.html";
      }
    });

    startBtn.addEventListener("click", () => {
      const selectedSubjects = Array.from(filterSection.querySelectorAll("input:checked")).map(cb => cb.value);
      if (selectedSubjects.length === 0) return alert("Selecione ao menos uma matéria.");
      let filtered = allQuestions.filter(q => selectedSubjects.includes(q.subject));
      while (filtered.length < 45) filtered = filtered.concat(filtered);
      selectedQuestions = filtered.slice(0, 45);
      filterSection.style.display = "none";
      quizApp.style.display = "block";
      timerElement.style.display = "block";
      startQuiz();
    });

    function startQuiz() {
      currentQuestionIndex = 0;
      score = 0;
      totalTime = 2 * 60 * 60 + 30 * 60;
      updateTimerDisplay();
      startTimer();
      showQuestion();
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        totalTime--;
        if (totalTime <= 0) {
          clearInterval(timerInterval);
          showScore();
        }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const h = String(Math.floor(totalTime / 3600)).padStart(2, "0");
      const m = String(Math.floor((totalTime % 3600) / 60)).padStart(2, "0");
      const s = String(totalTime % 60).padStart(2, "0");
      timerElement.textContent = `${h}:${m}:${s}`;
    }

    function showQuestion() {
      resetState();
      const q = selectedQuestions[currentQuestionIndex];
      questionElement.innerText = `${currentQuestionIndex + 1}. ${q.question}`;
      q.answers.forEach(ans => {
        const btn = document.createElement("button");
        btn.innerText = ans.text;
        btn.classList.add("btn");
        btn.dataset.correct = ans.correct;
        answerButtons.appendChild(btn);
        btn.addEventListener("click", selectAnswer);
      });
      updateProgressBar();
    }

    function resetState() {
      nextButton.style.display = "none";
      answerButtons.innerHTML = "";
    }

    function selectAnswer(e) {
      const correct = e.target.dataset.correct === "true";
      if (correct) {
        e.target.classList.add("correct");
        score++;
      } else e.target.classList.add("incorrect");

      Array.from(answerButtons.children).forEach(btn => {
        if (btn.dataset.correct === "true") btn.classList.add("correct");
        btn.disabled = true;
      });
      nextButton.style.display = "block";
    }

    function updateProgressBar() {
      const progress = ((currentQuestionIndex + 1) / selectedQuestions.length) * 100;
      progressBar.value = progress;
    }

    function showScore() {
      clearInterval(timerInterval);
      resetState();
      questionElement.innerHTML = `<h2>Fim do Quiz</h2><p>Acertos: <strong>${score}</strong> / ${selectedQuestions.length}</p><p>Erros: <strong>${selectedQuestions.length - score}</strong></p>`;
      answerButtons.innerHTML = `<button class="btn" onclick="window.location.reload()">Tentar novamente</button>`;
      nextButton.style.display = "none";
      timerElement.style.display = "none";
      progressBar.style.display = "none";
      if (currentUser) {
        setDoc(doc(db, "quizResults", currentUser.uid), {
          score, totalQuestions: selectedQuestions.length,
          tempoRestante: timerElement.textContent, timestamp: serverTimestamp()
        });
      }
    }

    nextButton.addEventListener("click", () => {
      currentQuestionIndex++;
      if (currentQuestionIndex < selectedQuestions.length) showQuestion();
      else showScore();
    });
  </script>
</body>
</html>
