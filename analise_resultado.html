<!-- Continua seu código atual ... -->

<div class="container">
  <!-- ... Seu conteúdo atual -->

  <h2>Históricos Anteriores</h2>
  <div id="history-list">
    <p>Carregando históricos anteriores...</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCj8i37JYNigvbhXfqP4HVzjAEOzcXf_i0",
    authDomain: "sdel-b3f65.firebaseapp.com",
    projectId: "sdel-b3f65",
    storageBucket: "sdel-b3f65.firebasestorage.app",
    messagingSenderId: "297725999985",
    appId: "1:297725999985:web:d41da68311c190ef8a54d0",
    measurementId: "G-PT92VECJ2H"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const acertosElem = document.getElementById('acertos');
  const errosElem = document.getElementById('erros');
  const pontuacaoElem = document.getElementById('pontuacao');
  const progressFillElem = document.getElementById('progress-fill');
  const questionListElem = document.getElementById('question-list');
  const historyListElem = document.getElementById('history-list');

  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert("Você precisa estar logado para ver o resultado.");
      window.location.href = "login.html";
      return;
    }

    try {
      // Resultado atual
      const docRef = doc(db, "quizResults", user.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();

        const score = data.score ?? 0;
        const totalQuestions = data.totalQuestions ?? 0;
        const answers = data.answers ?? [];

        const erros = totalQuestions - score;
        const porcentagem = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;

        acertosElem.textContent = score;
        errosElem.textContent = erros;
        pontuacaoElem.textContent = porcentagem + '%';
        progressFillElem.style.width = porcentagem + '%';
        progressFillElem.textContent = porcentagem + '%';

        questionListElem.innerHTML = '';

        answers.forEach((item, index) => {
          const div = document.createElement('div');
          div.classList.add('question-item');
          div.classList.add(item.isCorrect ? 'correct' : 'incorrect');

          div.innerHTML = `
            <p><span class="emoji">${item.isCorrect ? '✅' : '❌'}</span><strong>Pergunta ${index + 1}:</strong> ${item.question}</p>
            ${item.isCorrect ?
              '<p>Você acertou!</p>' :
              `<p>Sua resposta: ${item.userAnswer}<br>Correta: ${item.correctAnswer}</p>`
            }
          `;

          questionListElem.appendChild(div);
        });
      } else {
        alert("Nenhum resultado encontrado para este usuário.");
        window.location.href = "quiz.html";
        return;
      }

      // Buscar históricos anteriores (excluindo o resultado atual)
      const historyQuery = query(
        collection(db, "quizHistory"),
        where("userId", "==", user.uid),
        orderBy("date", "desc")
      );

      const querySnapshot = await getDocs(historyQuery);

      if (querySnapshot.empty) {
        historyListElem.innerHTML = '<p>Nenhum histórico anterior encontrado.</p>';
      } else {
        historyListElem.innerHTML = ''; // limpa

        querySnapshot.forEach(doc => {
          const hData = doc.data();

          // Ignorar o resultado atual se estiver salvo na mesma coleção, ou você pode adaptar isso
          // Se o resultado atual está só no "quizResults" e históricos são outros, ok.

          const date = hData.date ? hData.date.toDate().toLocaleString('pt-BR') : "Data desconhecida";
          const scoreHist = hData.score ?? 0;
          const totalQHist = hData.totalQuestions ?? 0;
          const pct = totalQHist > 0 ? Math.round((scoreHist / totalQHist) * 100) : 0;

          const divHist = document.createElement('div');
          divHist.classList.add('score-box');
          divHist.style.marginBottom = '10px';

          divHist.innerHTML = `
            <h3>Data: ${date}</h3>
            <p><strong>Acertos:</strong> ${scoreHist} / ${totalQHist}</p>
            <p><strong>Aproveitamento:</strong> ${pct}%</p>
          `;

          historyListElem.appendChild(divHist);
        });
      }

    } catch (error) {
      alert("Erro ao buscar resultado: " + error.message);
    }
  });
</script>
